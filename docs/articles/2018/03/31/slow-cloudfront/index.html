
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>S3 x Cloudfront なのに遅い時</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="author" content="Hidetatsu Yaginuma">

  <link href="/markdown.css" rel="stylesheet"></link>
</head>


<body>
<h2><a href="/">dtyler.io</a></h2>

<h1><a href="/article/2018/03/31/slow-cloudfront/">S3 x Cloudfront なのに遅い時</a></h1>

<p>2018/03/31</p>

<p>S3にアセットを置いてCloudFrontのディストリビューションから配信する。というのは、
クラウドデザインパターンのひとつでもあり、有用な戦略である。
CloudFrontはCDNで、エッジサーバにアセットをキャッシュしてくれるから速い。というのは基本的に正しいんだけど、
たまに(大体特定のファイルだけ)遅い。ということがある。</p>

<h2>原因</h2>

<p>特に、特定のファイルだけ遅い。というケースでは、ファイルがハードディスクに保存され、かつうまくセクタに載ってくれてないことが多い。</p>

<p>つまり、</p>

<ul>
<li>Bad Sectorに載ってしまっている</li>
<li>フラグメントされてしまっている</li>
</ul>

<p>ということが考えられる。
なお、ここでいうハードディスクとは、S3側、CloudFrontのエッジ側両方の話である。</p>

<p>BadSectorは、日本語でもバッドセクタというっぽいけど、
ハードウェア起因でwrite/readができなくなってしまったセクタのことを言う。(たぶん)</p>

<p>また、フラグメントとは、ファイルの断片化を言う。
同じファイルが連続したセクタに乗らず、離れたセクタに分散してしまっていることを言う。
離れたセクタに乗ること自体はよくあることで、昔のWindowsだと <strong>デフラグ</strong> で断片化を直したりしていたはず。</p>

<h2>切り分け方</h2>

<p>原因がS3にあるのか、CloudFrontにあるのかを調べるのは大切。
やり方としては、CloudFrontを外してみて、S3のエンドポイントから取得した時のレイテンシを計測すればいい。
速度が変わらなければS3が原因だし、早くなったらエッジ側に原因がある。</p>

<p>(ただし、理論上は両方が原因ということもある。)</p>

<h2>直し方</h2>

<p>直し方はいくつかある。</p>

<h3>ファイル名を変更してみる</h3>

<p>ファイル名を変更すると、別ファイルとみなされ、セクタが変わるので、運が良ければうまくいく。
ただ、これをやるとその結果別のファイルが遅くなったりすることがある。</p>

<h3>CloudFrontをやめる</h3>

<p>高速化できればいいなら、Akamai、FastlyなどのフルSSDなCDNを使うという手もある。
ただし、理論上はSSDでもバッドセクタは発生する(正確にはバッドブロック)ので、注意。</p>

</body>

</html>
