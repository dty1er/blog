
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>DatadogからLambdaを叩く</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="author" content="Hidetatsu Yaginuma">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
  <link href="https://cdn.jsdelivr.net/npm/github-markdown-css@3.0.1/github-markdown.min.css" rel="stylesheet"></link>
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
  </script>
</head>


<body class="markdown-body">
<h1><a href="/">dtyler.io</a></h1>

<h1>DatadogからLambdaを叩く</h1>

<h4>2017/09/22</h4>

<p>今日、会社のブログで<a href="https://blog.mmmcorp.co.jp/blog/2017/06/02/starting-datadog/">こういう記事</a>を書いた。
システム監視の一環で、DDからアラートが上がった時に担当者に電話をかけたい、というのがやりたいことである。
これは内部的な仕組みとして、DDのアラートがWebhookを飛ばす -&gt; CloudFront -&gt; API Gateway -&gt; Lambda という流れになっている。</p>

<h3>CloudFront</h3>

<p>こちらを参考に、CloudFrontを使ってAPI Gatewayを叩いている。
DDのWebhookは暗号化プロトコルにSSLv3を使っているので、API Gatewayを直接叩くことができない。
そのため、API Gatewayの前段にCloudFrontをかませている。</p>

<h3>日本語を送る</h3>

<p>日本語の送信で、色々ハマってしまった。試行錯誤の結果、以下のようなやり方を取った。
* DD側でURLエンコーディングしてフックする
* Lambda側でデコードして日本語を使う</p>

<h3>DD側でURLエンコーディング</h3>

<p>これは簡単で、 Integrations Webhook からエンコーディングにチェックを入れる。</p>

<h3>Lambdaでの扱い方</h3>

<p>API Gatewayのログ(Request Body)を見ると以下のような感じになっていた。</p>

<pre><code>event_type=query_alert_monitor&amp;alert_id=XXXXXXXX&amp;alert_transition=Recovered&amp;date=1505904673000&amp;alert_title=%E3%83%87%E3%82%A3%E3%82%B9%E3
</code></pre>

<p>URLエンコーディングしてなければJSONでポストされ、Pythonではdict型で扱える。
しかし、URLのクエリパラメータとして来る場合は、以下のようにすると扱いやすい。(Python2.7です。)</p>

<pre><code>import urlparse
import urllib

def handle(event, context):
    // この時点ではeventはdict
    request = str(event[''body''])
    // クエリパラメータをパース
    params = urlparse.parse_qs(request)
    event_type_encoding = params[''event_type''][0]
    // デコード
    event_type_decoded = urllib.unquote(event_type_encoding)
</code></pre>

<p>こうするとデコードして、日本語がされることを日本語として扱える。</p>

<hr>

<p><a href="/">home</a></p>

</body>

</html>
